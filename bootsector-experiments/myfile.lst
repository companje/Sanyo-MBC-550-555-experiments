     1                                  ; Rick Companje, March 29th, 2022
     2                                  cpu 8086
     3                                  org 0x0
     4                                  
     5                                  ;     jmp code
     6                                  
     7                                  ;     db 'Sanyo1.2'
     8                                  ;     db 0x00,0x02,0x02,0x01,0x00,0x02,0x70,0x00,
     9                                  ;     db 0xd0,0x02,0xfd,0x02,0x00,0x09,0x00,0x02,
    10                                  ;     db 0x00,0x00,0x00,0x00,0x00,0x1c,0x00,0xff,
    11                                  ;     db '       Sanyo MBC-550/555        ',0x00
    12                                  
    13                                  cols equ 80
    14                                  rows equ 25
    15                                  lines equ 200
    16                                  ; startpos equ 4*24 + 4*cols*8
    17                                  
    18                                  ; %define t ch  ; dit werkt op zich
    19                                  
    20                                  ; setProfile:
    21                                  ;     mov bx,0
    22                                  ;     cld
    23                                  ; .lp:
    24                                  ;     mov al,bl
    25                                  ;     out 0x30,al            ;CRTC address port
    26                                  ;     mov al,[cs: bx+si+0]
    27                                  ;     out 0x32,al            ;CRTC data port
    28                                  ;     inc bx
    29                                  ;     cmp bl,10
    30                                  ;     jl .lp
    31                                  ;     ret
    32                                  
    33                                  ; profile25x80:
    34                                  ;     db 112  ;0  Horizontal Total
    35                                  ;     db 80   ;1  Horizontal Displayed
    36                                  ;     db 88   ;2  Horizontal Sync Position
    37                                  ;     db 0x4a ;3  Horizontal and Vertical Sync Widths
    38                                  ;     db 65   ;4  Vertical Total
    39                                  ;     db 0    ;5  Vertical Total Adjust
    40                                  ;     db 50   ;6  Vertical Displayed
    41                                  ;     db 56   ;7  Vertical Sync position
    42                                  ;     db 0    ;8  Interlace and Skew
    43                                  ;     db 3    ;9  Maximum Raster Address
    44                                  
    45                                  
    46                                  setup:
    47 00000000 E82600                      call clearScreen
    48                                  
    49                                  draw:
    50 00000003 BD00F0                      mov bp,0xf000
    51 00000006 8EC5                        mov es,bp
    52                                      ; mov di,0
    53                                      ; mov al,255
    54                                      ; stosb
    55                                  
    56 00000008 FC                          cld
    57 00000009 BF0000                      mov di,0
    58 0000000C 0E                          push cs
    59 0000000D 1F                          pop ds
    60                                      
    61 0000000E BE[2300]                    mov si,img
    62                                      ; add si,15
    63                                      ; mov cx,10
    64                                      ; rep movsw
    65                                      ; mov al,255
    66                                      ; stosb
    67                                  
    68 00000011 A5                          movsw
    69 00000012 A5                          movsw
    70 00000013 81C73C01                    add di,320-4
    71 00000017 A4                          movsb
    72 00000018 4E<rep 2h>                  times 2 dec si
    73 0000001A A4                          movsb
    74 0000001B 4E<rep 2h>                  times 2 dec si
    75 0000001D A4                          movsb
    76 0000001E 4E<rep 2h>                  times 2 dec si
    77 00000020 A4                          movsb
    78                                      
    79                                      ; times 2 dec si
    80                                      ; movsb
    81                                      ; or byte [es:di-320],0xff
    82                                  
    83                                  
    84                                      ; movsb
    85                                      ; std
    86                                      ; sub si,16
    87                                      ; add di,320-8
    88                                      ; movsw
    89                                      ; movsw
    90                                      ; ; movsw
    91                                      ; movsw
    92                                      ; movsw
    93                                  
    94                                      ; mov si,ax
    95                                      ; add si,img+128
    96                                      ; movsw
    97                                      ; movsw
    98                                      ; movsw
    99                                      ; movsw
   100                                  
   101                                      ; mov bp,0x0c00
   102                                      ; mov di,9*4*cols+cols 
   103                                      ; call dot
   104                                  
   105 00000021 EBE0                        jmp draw
   106                                  
   107                                  img:
   108                                      ; db 0x00,0x00,0x00,0x00,0x00  ; 0 leeg
   109                                      ; db 0x00,0x00,0x00,0x00,0x01  ; 1 stipje
   110                                      ; db 0x00,0x00,0x00,0x00,0x03  ; 2 minnetje
   111                                      ; db 0x00,0x00,0x00,0x01,0x03  ; 3 plusje
   112                                      ; db 0x00,0x00,0x00,0x03,0x07  ; 4 hoofdje
   113                                      ; db 0x00,0x00,0x00,0x07,0x07  ; 5 blokje
   114                                      ; db 0x00,0x00,0x01,0x07,0x0F  ; 6 sterretje
   115                                      ; db 0x00,0x00,0x03,0x0F,0x0F  ; 7 rode kruis
   116                                      ; db 0x00,0x00,0x07,0x0F,0x1F  ; 8 ..
   117                                      ; db 0x00,0x01,0x0F,0x1F,0x1F  ; 9 ..
   118                                      ; db 0x00,0x07,0x1F,0x1F,0x3F  ; 10 ..
   119                                      ; db 0x00,0x0F,0x1F,0x3F,0x3F  ; 11 ..
   120 00000023 011F3F7F7F01                db 0x01,0x1F,0x3F,0x7F,0x7F,0x01  ; 12 groot met puntje
   121                                      ; db 0x07,0x1F,0x3F,0x7F,0x7F  ; 13 ..
   122                                      ; db 0x0F,0x3F,0x7F,0xFF,0xFF  ; 14 ..
   123                                      ; db 0x1F,0x7F,0xFF,0xFF,0xFF  ; 15 ..
   124                                  
   125                                  ; setpix:
   126                                  ;     32cols
   127                                  
   128                                  ; dot:
   129                                  ;     mov es,bp
   130                                  ;     mov al,255
   131                                  ;     stosb
   132                                  ;     ret
   133                                  
   134                                  ;     ; call drawchar
   135                                      
   136                                  ;     jmp draw
   137                                  
   138                                  ;     mov ax,0x0c00
   139                                  ;     mov es,ax
   140                                  ;     xor bp,bp
   141                                  ;     mov dh,0    ; t
   142                                  
   143                                  ;     mov dl,0    ; i
   144                                  ;     mov bl,0    ; y
   145                                  ;     mov di,9*4*cols+cols    ; view top left
   146                                  ; repeatY:
   147                                  ;     mov bh,0    ; x
   148                                  ; repeatX:
   149                                  ;     ; push bp
   150                                  ;     ; push bx
   151                                  ;     ; xchg bx,bp
   152                                  ;     ; mov bp,[bx+table]
   153                                  ;     ; and bp,0xff
   154                                  ;     ; or bp,0x100
   155                                  ;     ; pop bx
   156                                  ;     ; call bp
   157                                  ;     ; pop bp
   158                                  
   159                                  
   160                                      ;effect
   161                                      ; mov al,bh
   162                                      ; mul bl
   163                                      ; add al,dh
   164                                  
   165                                  
   166                                  ;     push bx
   167                                  ;     cmp al,0
   168                                  ;     jge white
   169                                  ; gray:
   170                                  ;     mov bx,0xf400
   171                                  ;     mov es,bx
   172                                  ;     neg al
   173                                  ;     call drawchar
   174                                  ;     mov bx,0x0c00
   175                                  ;     mov es,bx
   176                                  ;     mov al,0
   177                                  ;     call drawchar
   178                                  ;     jmp nextchar
   179                                  ; white:
   180                                  ;     mov bx,0x0c00
   181                                  ;     mov es,bx
   182                                  ;     call drawchar
   183                                  ;     mov bx,0xf400
   184                                  ;     mov es,bx
   185                                  ;     call drawchar
   186                                  
   187                                  ; nextchar:
   188                                  ;     pop bx
   189                                  ;     add di,8
   190                                  ;     inc dl        ; i++
   191                                  ;     inc bh        ; x++
   192                                  ;     cmp bh,16
   193                                  ;     jl repeatX
   194                                  ;     add di,192+320
   195                                  ;     inc bl        ; y++
   196                                  ;     cmp bl,16
   197                                  ;     jl repeatY
   198                                  
   199                                  
   200                                  ; drawchar:
   201                                  ;     push di
   202                                  ;     push ax
   203                                  ;     and al,15    ; limit to 4 lower bits [0..15]
   204                                  ;     mov cl,8
   205                                  ;     mul cl        ; ax=al*8
   206                                  
   207                                  ;     mov si,ax
   208                                  ;     add si,img
   209                                  ;     movsw
   210                                  ;     movsw
   211                                  ;     movsw
   212                                  ;     movsw
   213                                  ;     add di,320-8
   214                                  ;     mov si,ax
   215                                  ;     add si,img+128
   216                                  ;     movsw
   217                                  ;     movsw
   218                                  ;     movsw
   219                                  ;     movsw
   220                                  ; ;sub di,320-8
   221                                  ;     pop ax
   222                                  ;     pop di
   223                                  ;     ret
   224                                  
   225                                  ; draw:
   226                                  ;     mov bp,0xf000  ; red
   227                                  ;     mov di,0
   228                                  ;     call dot
   229                                  
   230                                  ;     mov bp,0x0c00  ; green
   231                                  ;     mov di,0
   232                                  ;     call dot
   233                                  
   234                                  ;     mov bp,0xf400  ; blue
   235                                  ;     mov di,0
   236                                  ;     call dot
   237                                  
   238                                  ;     jmp draw
   239                                  
   240                                  ; dot:
   241                                  ;     mov es,bp
   242                                  ;     mov al,255
   243                                  ;     stosb
   244                                  ;     ret
   245                                  
   246                                  clearScreen:
   247 00000029 FC                          cld
   248                                  
   249 0000002A B000                        mov al,0    ; pattern
   250 0000002C BD00F0                      mov bp,0xf000  ; red
   251 0000002F 8EC5                        mov es,bp
   252 00000031 BF0000                      mov di,0
   253 00000034 B9803E                      mov cx,cols*lines
   254 00000037 F3AA                        rep stosb
   255                                  
   256 00000039 BD000C                      mov bp,0x0c00  ; green
   257 0000003C 8EC5                        mov es,bp
   258 0000003E BF0000                      mov di,0
   259 00000041 B9803E                      mov cx,cols*lines
   260 00000044 F3AA                        rep stosb
   261                                  
   262 00000046 BD00F4                      mov bp,0xf400  ; blue
   263 00000049 8EC5                        mov es,bp
   264 0000004B BF0000                      mov di,0
   265 0000004E B9803E                      mov cx,cols*lines
   266 00000051 F3AA                        rep stosb
   267                                  
   268 00000053 C3                          ret
   269                                  
   270                                  
   271                                  ; img:
   272                                  ;     db 0,0,0,0,  0,0,0,0,  0,0,0,0,  0,0,0,128
   273                                  ;     db 0,0,0,1,  0,0,0,192,  0,0,0,1,  0,0,0,192
   274                                  ;     db 0,0,0,3,  0,0,128,224,  0,0,0,3,  0,0,128,224
   275                                  ;     db 0,0,3,7,  0,0,224,240,  0,0,3,7,  0,0,224,240
   276                                  ;     db 0,0,7,15,  0,128,240,248,  0,0,7,15,  0,128,240,248
   277                                  ;     db 0,3,15,31,  0,224,248,252,  0,7,31,31,  0,240,252,252
   278                                  ;     db 0,15,31,63,  128,248,252,254,  0,15,63,63,  128,248,254,254
   279                                  ;     db 7,31,63,127, 240,252,254,255, 7,63,127,127, 240,254,255,255
   280                                      
   281                                  ;     db 0,0,0,0,  0,0,0,0,  0,0,0,0,  0,0,0,0
   282                                  ;     db 0,0,0,0,  0,0,0,0,  0,0,0,0,  0,0,0,0
   283                                  ;     db 0,0,0,0,  128,0,0,0,  0,0,0,0,  128,0,0,0
   284                                  ;     db 3,0,0,0,  224,0,0,0,  3,0,0,0,  224,0,0,0
   285                                  ;     db 7,0,0,0,  240,128,0,0,  7,0,0,0,  240,128,0,0
   286                                  ;     db 15,3,0,0,  248,224,0,0,  31,7,0,0,  252,240,0,0
   287                                  ;     db 31,15,0,0,  252,248,128,0,  63,15,0,0,  254,248,128,0
   288                                  ;     db 63,31,7,0,  254,252,240,0,  127,63,7,0,  255,254,240,0
   289                                  
   290                                  
   291                                  ; code:  
   292                                  ;     ; call setDisplayMode80x25
   293                                  ;     ; mov si,profile25x80
   294                                  ;     ; call setProfile
   295                                  ;     call clearScreen
   296                                  
   297                                  ; ; _loop:
   298                                  ; ;     jmp _loop
   299                                  
   300                                  ;     ; push cs
   301                                  ;     ; pop ds              ; data=code segment
   302                                  
   303                                  ; draw:
   304                                  ;     mov ch,0            ; t
   305                                  ; top:
   306                                  ;     mov cl,0            ; i
   307                                  ;     mov di,startpos
   308                                  ;     mov dh,0            ; y           
   309                                  ; repeatY:
   310                                  ;     mov dl,0            ; x
   311                                  ; repeatX:
   312                                  ;     ; push bx
   313                                  ;     ; cs call fx0
   314                                  ;     ; mov al,dh
   315                                      
   316                                  ;     ; pop bx
   317                                  
   318                                  ;     ; mov al,15
   319                                  ;     ; add al,ch
   320                                  ;     ; push bx
   321                                  ;     ; mov bx,buf
   322                                  ;     ; mov al,cl
   323                                  ;     ; times 4 shr al,1
   324                                  ;     ; sub al,7
   325                                  ;     ; cs xlat
   326                                  ;     ; pop bx
   327                                  
   328                                  ;     ; mov al,dh           ; y
   329                                  ;     ; times 3 shr al,1    ; /=8
   330                                  ;     ; ; add al,ch           ; +=t
   331                                  ;     ; and al,15           ; wrap (werkt dit ook voor negatieve getallen?)
   332                                  ;     ; ; times 2 shl al,1    ; *=4
   333                                  ;     ; mov bx,sin
   334                                  ;     ; cs xlat                ; extract sin value
   335                                  ;     mov al,cl
   336                                  ;     times 4 shr al,1    ; /=16
   337                                  ;     add al,ch
   338                                  
   339                                      
   340                                  
   341                                  ;     call draw_dot_color
   342                                  ;     inc dl              ; x
   343                                  ;     inc cl              ; i
   344                                  ;     add di,8
   345                                  ;     cmp dl,16
   346                                  ;     jl repeatX
   347                                  ;     mov dl,0
   348                                  ;     add di,(cols-16)*8    ; skip remaining cols
   349                                  ;     inc dh
   350                                  ;     cmp dh,16
   351                                  ;     jl repeatY
   352                                  ;     inc ch              ; t
   353                                  ;     jmp top
   354                                  
   355                                  
   356                                  
   357                                  ; fx0:
   358                                  ;     mov al,ch           ; t
   359                                  ;     times 2 shr al,1    ; /=2
   360                                  ;     and al,15           ; wrap (werkt dit ook voor negatieve getallen?)
   361                                  ;     times 2 shl al,1    ; *=4
   362                                  ;     mov bx,sin
   363                                  ;     cs xlat                ; extract sin value
   364                                  ;     ret
   365                                  
   366                                  ; draw_dot_color:
   367                                  ;     mov bx,0xf000    ; red
   368                                  ;     call draw_dot
   369                                  ;     or al,al
   370                                  ;     jns .draw_blue_green  ; check sign bit for negative number
   371                                  ;     mov al,0         ; clear dot on blue and green channel
   372                                  ; .draw_blue_green:
   373                                  ;     neg al
   374                                  ;     mov bx,0xf400    ; blue
   375                                  ;     call draw_dot
   376                                  ;     mov bx,0x0c00    ; green
   377                                  ;     call draw_dot
   378                                  ;     ret
   379                                  
   380                                  ; draw_dot:
   381                                  ;     push di
   382                                  ;     push ax
   383                                  ;     push cx
   384                                  ;     mov ah,al    
   385                                  ;     or al,al
   386                                  ;     jns .positive
   387                                  ;     neg al
   388                                  ; .positive:
   389                                  ;     mov es,bx    ; vram
   390                                  ;     and al,15    ; limit to 15 (4 bits)
   391                                  ;     mov cl,8
   392                                  ;     mul cl    ; ax=al*8
   393                                  ;     mov si,ax
   394                                  ;     add si,img
   395                                  ;     times 4 cs movsw
   396                                  ;     add di,(4*cols)-8
   397                                  ;     mov si,ax
   398                                  ;     add si,img+128
   399                                  ;     times 4 cs movsw
   400                                  ;     pop cx
   401                                  ;     pop ax
   402                                  ;     pop di
   403                                  ;     ret
   404                                  
   405                                  ; table: db fx0
   406                                  
   407                                  ; sin:
   408                                  ;     db 0x00,0x01,0x03,0x04,0x06,0x07,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0E,0x0F,0x0F,0x0F
   409                                  ;     db 0x0F,0x0F,0x0F,0x0F,0x0E,0x0E,0x0D,0x0C,0x0B,0x0A,0x09,0x07,0x06,0x04,0x03,0x01
   410                                  
   411                                  ;     db 0x00,0xFF,0xFD,0xFC,0xFA,0xF9,0xF7,0xF6,0xF5,0xF4,0xF3,0xF2,0xF2,0xF1,0xF1,0xF1
   412                                  ;     db 0xF1,0xF1,0xF1,0xF1,0xF2,0xF2,0xF3,0xF4,0xF5,0xF6,0xF7,0xF9,0xFA,0xFC,0xFD,0xFF
   413                                  
   414                                  ; img:
   415                                  ;     db 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80
   416                                  ;     db 0x00,0x00,0x00,0x01,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0xC0
   417                                  ;     db 0x00,0x00,0x00,0x03,0x00,0x00,0x80,0xE0,0x00,0x00,0x00,0x03,0x00,0x00,0x80,0xE0
   418                                  ;     db 0x00,0x00,0x03,0x07,0x00,0x00,0xE0,0xF0,0x00,0x00,0x03,0x07,0x00,0x00,0xE0,0xF0
   419                                  ;     db 0x00,0x00,0x07,0x0F,0x00,0x80,0xF0,0xF8,0x00,0x00,0x07,0x0F,0x00,0x80,0xF0,0xF8
   420                                  ;     db 0x00,0x03,0x0F,0x1F,0x00,0xE0,0xF8,0xFC,0x00,0x07,0x1F,0x1F,0x00,0xF0,0xFC,0xFC
   421                                  ;     db 0x00,0x0F,0x1F,0x3F,0x80,0xF8,0xFC,0xFE,0x00,0x0F,0x3F,0x3F,0x80,0xF8,0xFE,0xFE
   422                                  ;     db 0x07,0x1F,0x3F,0x7F,0xF0,0xFC,0xFE,0xFF,0x07,0x3F,0x7F,0x7F,0xF0,0xFE,0xFF,0xFF
   423                                  ;     db 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
   424                                  ;     db 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
   425                                  ;     db 0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00
   426                                  ;     db 0x03,0x00,0x00,0x00,0xE0,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0xE0,0x00,0x00,0x00
   427                                  ;     db 0x07,0x00,0x00,0x00,0xF0,0x80,0x00,0x00,0x07,0x00,0x00,0x00,0xF0,0x80,0x00,0x00
   428                                  ;     db 0x0F,0x03,0x00,0x00,0xF8,0xE0,0x00,0x00,0x1F,0x07,0x00,0x00,0xFC,0xF0,0x00,0x00
   429                                  ;     db 0x1F,0x0F,0x00,0x00,0xFC,0xF8,0x80,0x00,0x3F,0x0F,0x00,0x00,0xFE,0xF8,0x80,0x00
   430                                  ;     db 0x3F,0x1F,0x07,0x00,0xFE,0xFC,0xF0,0x00,0x7F,0x3F,0x07,0x00,0xFF,0xFE,0xF0,0x00
   431                                  
   432                                  ; buf:
   433                                  ;     times 16*16 db 5
   434                                  
   435                                  ; %include "lib.asm"
   436                                  ; incbin "Sanyo-MS-DOS-2.11-minimal.img",($-$$)  ; include default disk image skipping first 512 bytes
   437                                  
