     1                                  ; Rick Companje, April 23, 2022
     2                                  cpu 8086
     3                                  org 0x0
     4                                  
     5                                  cols equ 80
     6                                  rows equ 25
     7                                  lines equ 200
     8                                  
     9                                  setup:
    10 00000000 E85500                      call cls
    11                                  
    12                                  draw:
    13 00000003 FC                          cld
    14 00000004 BD00F0                      mov bp,0xf000   ;red
    15 00000007 8EC5                        mov es,bp
    16 00000009 BF0000                      mov di,0
    17                                  
    18 0000000C 0E                          push cs
    19 0000000D 1F                          pop ds    ; mov ds,cs
    20                                  
    21 0000000E 31C0                        xor ax,ax
    22 00000010 B91000                      mov cx,16
    23 00000013 51                      y:  push cx
    24 00000014 B91000                      mov cx,16
    25                                  x:  
    26 00000017 89C8                        mov ax,cx
    27 00000019 48                          dec ax
    28 0000001A D1E0<rep 2h>                times 2 shl ax,1 ; AL*=4
    29 0000001E 05[6F00]                    add ax,img
    30 00000021 96                          xchg ax,si
    31                                  
    32                                  
    33 00000022 A5                          movsw
    34 00000023 A5                          movsw
    35 00000024 83C704                      add di,4
    36 00000027 E2EE                        loop x
    37 00000029 81C70002                    add di,512; 192 + 320; 192=remaining space, 320=whole row
    38 0000002D 59                          pop cx
    39 0000002E E2E3                        loop y
    40                                      
    41                                  
    42                                  ; horizontal mirrored copy
    43 00000030 BF0400                      mov di,4
    44 00000033 31F6                        xor si,si
    45                                  
    46 00000035 B98000                      mov cx,16*2*4
    47                                  hcopy:
    48 00000038 BD000C                      mov bp,0x0c00  ;dest green
    49 0000003B 8EC5                        mov es,bp  ; dst with di
    50 0000003D BD00F0                      mov bp,0xf000  ;source red
    51 00000040 8EDD                        mov ds,bp  ; src with si
    52                                  
    53                                      ; push cx
    54                                      ; mov cx,4
    55                                  lines_in_row:
    56 00000042 AC                          lodsb
    57                                  
    58 00000043 51                          push cx    ; somehow repne scasb destroys cx
    59 00000044 06                          push es
    60 00000045 57                          push di
    61                                  
    62 00000046 0E                          push cs
    63 00000047 07                          pop es    ; es=cs
    64                                  
    65 00000048 BF[AF00]                    mov di,lut
    66 0000004B F2AE                        repne scasb ; cmp al,es:di, inc di
    67 0000004D 268A4508                    es mov al,[di+8] ; mirror using lut
    68                                  
    69 00000051 5F                          pop di
    70 00000052 07                          pop es
    71 00000053 59                          pop cx
    72                                      
    73 00000054 AA                          stosb
    74                                  
    75                                      ; loop lines_in_row
    76                                      ; pop cx
    77                                      ; add si,4 ;skip 1 column
    78                                      ; add di,4 ;skip 1 column
    79                                  
    80 00000055 E2E1                        loop hcopy
    81                                  
    82                                  
    83 00000057 F4                          hlt
    84                                  
    85                                  ; copy mirrored    
    86                                  
    87                                  ;row2
    88                                  ;     mov bp,0x0c00  ;red
    89                                  ;     mov es,bp
    90                                  ;     mov di,320+4
    91                                  
    92                                  ;     mov si,img
    93                                  ;     mov cx,4*16
    94                                  ; repX:
    95                                  ;     lodsb
    96                                  
    97                                  ;     push cx    ; somehow repne scasb destroys cx
    98                                  ;     push es
    99                                  ;     push di
   100                                  
   101                                  ;     push cs
   102                                  ;     pop es    ; es=cs
   103                                  
   104                                  ;     mov di,lut
   105                                  
   106                                  ;     repne scasb ; cmp al,es:di, inc di
   107                                  ;     mov al,[di+8]
   108                                      
   109                                  ;     pop di
   110                                  ;     pop es
   111                                  ; pop cx
   112                                      
   113                                  ;     stosb
   114                                  
   115                                  
   116                                  ;     ; add di,3*4
   117                                  ;     loop repX
   118                                  
   119                                  
   120                                  ;     jmp draw
   121                                  
   122                                  ; flip_bits:     ; flip the bits of al
   123                                    ;   push cx
   124                                    ;   push bx
   125                                    ;   mov cl,8
   126                                    ;   mov ah,0
   127                                    ; .bit: 
   128                                    ;   mov bx,0x8001 ; bl=1, bh=128
   129                                    ;   shr bh,cl
   130                                    ;   shl bl,cl
   131                                    ;   test al,bl
   132                                    ;   jz .cont
   133                                    ;   ; dec cx
   134                                    ;   or ah,bh
   135                                    ;   ; inc cx
   136                                    ; .cont:
   137                                    ;   loop .bit
   138                                    ;   mov al,ah
   139                                    ;   pop bx
   140                                    ;   pop cx
   141                                    ;   ret
   142                                  
   143                                  cls:
   144 00000058 B8000C                      mov ax,0x0c00
   145 0000005B B90040                      mov cx,0x4000
   146 0000005E 31FF                        xor di,di
   147 00000060 8EC0                        mov es,ax    ; green
   148 00000062 F3AA                        rep stosb
   149 00000064 B4F0                        mov ah,0xf0
   150 00000066 8EC0                        mov es,ax    ;  red + blue 
   151 00000068 31FF                        xor di,di
   152 0000006A B580                        mov ch,0x80
   153 0000006C F3AA                        rep stosb
   154 0000006E C3                          ret
   155                                      
   156                                  img: 
   157 0000006F 00000000                    db 0, 0, 0, 0
   158 00000073 00000001                    db 0, 0, 0, 1         ;punt
   159 00000077 00000003                    db 0, 0, 0, 3         ;min
   160 0000007B 00000103                    db 0, 0, 1, 3         ;plus
   161 0000007F 00000307                    db 0, 0, 3, 7         ;hoed
   162 00000083 00000707                    db 0, 0, 7, 7         ;blok
   163 00000087 0001070F                    db 0, 1, 7, 15        ;ster
   164 0000008B 00030F0F                    db 0, 3, 15, 15       ;dikke plus
   165 0000008F 000F1F3F                    db 0, 15, 31, 63   
   166 00000093 011F3F3F                    db 1, 31, 63, 63      ;tol
   167 00000097 071F1F3F                    db 7, 31, 31, 63      ;robothoofd
   168 0000009B 0F1F3F3F                    db 15, 31, 63, 63
   169 0000009F 0F3F3F7F                    db 15, 63, 63, 127
   170 000000A3 1F3F7F7F                    db 31, 63, 127, 127
   171 000000A7 1F7FFFFF                    db 31, 127, 255, 255
   172 000000AB 3F7FFFFF                    db 63, 127, 255, 255
   173                                  
   174                                  lut:
   175 000000AF 000103070F1F3F7FFF          db 0,1,3,7,15,31,63,127,255
   176 000000B8 000080C0E0F0F8FCFE          db 0,0,128,192,224,240,248,252,254
   177                                  
   178                                  
   179                                  ; result: ;4*16 bytes
