org 0
cpu 8086

H equ 50      ; 50x4 lines = 200px
W equ 72    ; =COLS
WH equ W*H
; RED   equ 0xf000
; GREEN_1 equ 0x1c00  ;; 4=0x0c00 5=0x1c00, 6=0x2c00, 7=0x3c00 ????

; BLUE  equ 0xf400

jmp setup

    db 'Sanyo1.2'
    dw 512     ; Number of bytes per sector
    db 2       ; Number of sectors per cluster
    db 1       ; Number of FAT copies
    dw 512     ; Number of root directory entries
    db 112     ; Total number of sectors in the filesystem
    db 0       ; Media descriptor type
    dw 512     ; Number of sectors per FAT
    dw 765     ; ? Number of sectors per track
    db 0     ; ? Number of heads   (now first byte of sine table)
    db 9     ; ? Number of heads  
    dw 512   ; Number of hidden sectors


setup:
    mov ax,0x1c00
    push ax
    pop es

    mov ax,0x0c00
    push ax
    pop ds

   
doublebuf:
    call initCells
    mov al,5        ; 0x0c00
    out 0x10,al

    ; swap es,ds
    push ds
    push es
    pop ds
    pop es

    call initCells2

    mov al,4         ; 0x1c00
    out 0x10,al

    ; swap es,ds
    push ds
    push es
    pop ds
    pop es

    jmp doublebuf

    hlt

; setDot: 

countNeighbours:  ;bh=x, bl=y
; .countNeighbours: ; input si, returns dl
;     mov dl,0    ; n
;     mov bx,0    ; bx 8..0  i<len(nb)
; .1: mov bp,[cs:nb+bx]
    ret

; nextgen:
;     ;calculate next generation
;     xor si,si
; .calc_cells:
;     ; call countNeighbours
;     ; int3

; .countNeighbours: ; input si, returns dl
;     mov dl,0    ; n
;     mov bx,0    ; bx 8..0  i<len(nb)
; .1: mov bp,[cs:nb+bx]
;     mov al,[es:si+bp]   ; read value of neighbouring pixel
;     test al,128
;     jz .2
;     inc dl
;     ; int3
; .2: inc bx
;     inc bx
;     cmp bx,16
;     jne .1
; ;------


;     mov al,0

;     cmp dl,2 
;     je .j32  
;     cmp dl,3
;     jne .set      ; not 2 and not 3 neighbours
; .j64: add al,32   ; 3 neighbours
; .j32: add al,32   ; 2 neighbours
; .set: 

;     ; mov al,dl
;     ; mov cl,64
;     ; mul cl

;     xor [es:si],al
;     add si,4
;     cmp si,WH*4
;     jl .calc_cells

; ; hlt

; ;redraw cells
;     ; mov cx,4*WH
;     ; xor si,si
;     xor di,di
; .redraw_cells:
;     mov al,[es:di]
;     test al,128    ; alive?
;     jz .dead
; .alive:
;     test al,64
;     jz .survive
;     test al,32
;     jz .survive
; .die:
; .stay_dead:
;     xor al,al
;     jmp .copy
; .dead:
;     test al,64
;     jz .stay_dead
; .birth:
; .survive:
;     mov al,255
; .copy:

;     mov [es:di+0],al
;     mov [es:di+1],al
;     mov [es:di+2],al
;     mov [es:di+3],al
;     add di,4

    
;     cmp di,WH*4
;     jl .redraw_cells


;     jmp nextgen

   

    ; ret

    ;checkme
nb: db -1,-1, 0,-1, 1,-1, -1,0, 1,0, -1,1, 0,1, 1,1
; dw -4,4,-W*4,W*4,-W*4-4,-W*4+4,W*4-4,W*4+4

;nb: db -1,1,-W,W,-W-1,-W+1,W-1,W+1
    

initCells:
    xor di,di
    mov cx,WH   
    mov bp,4
    mov bx,10000  ; probability (signed)
.1: mov ax,25173  ; LCG Multiplier
    mul bp        ; DX:AX = LCG multiplier * seed
    add ax,13849  ; Add LCG increment value ; Modulo 65536, AX = (multiplier*seed+increment) mod 65536
    mov bp,ax     ; Update seed = return value
    cmp ax,bx
    mov ax,255
    jg .2
    xor ax,ax
.2: push cx
    mov cx,4
    rep stosb
    pop cx
    loop .1
    ret
 

 initCells2:
    xor di,di
    mov cx,WH   
    mov bp,5
    mov bx,10000  ; probability (signed)
.1: mov ax,25173  ; LCG Multiplier
    mul bp        ; DX:AX = LCG multiplier * seed
    add ax,13849  ; Add LCG increment value ; Modulo 65536, AX = (multiplier*seed+increment) mod 65536
    mov bp,ax     ; Update seed = return value
    cmp ax,bx
    mov ax,255
    jg .2
    xor ax,ax
.2: push cx
    mov cx,4
    rep stosb
    pop cx
    loop .1
    ret


data:



rnd: db 0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,0,0,255,0,0,255,0,0,0,0,255,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,255,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,255,0,0,255,0,0,0,0,0,255,255,0,255,0,0,0,0,255,0,0,0,255,0,0,0,0,255,0,0,0,0,0,0,0,255,255,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,255,0,0,0,255,0,0,0,0,255,255,255,0,0,255,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,0,0,255,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,255,0,0,0,255,0,0,0,0,255,0,255,0,0,0,255,0,0,255,0,255,0,255,0,0,0,255,0,0,255,0,255,255,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,255,0,0,0,0,255,0,0,0,0,0,0,0,0,255,0,0,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,255,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,255,0,255,255,0,0,0,0,0,255,0,0,0,255,255,255,0,255,0,0,0,0,0,0,0,0,0,0,0,255,0,255,0,255,0,0,0,0,0,255,0,0,0,0,255,0,0,0,0,255,0,0,0,255,0,0,255,0,0,0,0,255,0,255,0,0,0,255,0,0,255,0,0,0,0,0,0,0,255,0,0,255,255,0,0,255,0,0,0,255,0,0,0,0,0,0,0,0,0,0,255,0,0,0,255,0,0,0,0,0,0,255,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,255,0,255,0,0,0,255,0,0,0,0,0,0,0,0,255,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0,0,255,0,255,0,0,0,0,0,0,255,0,0,255,0,0,0,0,0,255,255,0,255,0,0,0,0,0,0,255,255,255,0,0,0,0,0,0,0,0,0,255,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,255,0,255,0,0,0,0,0,0,255,0,0,0,255,0,0,0,255,255,255,255,255,0,0,0,0,0,0,255,0,0,255,0,0,255,0,0,0,0,255,0,0,0,0,0,0,255,255,0,0,255,0,0,0,0,0,0,255,255,0,255,0,0,0,0,0,255,0,0,0,0,0,255,0,0,0,0,0,0,0,255,0,0,0,255,0,0,255,0,0,255,0,255,255,0,0,0,255,0,255,0,0,255,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,255,255,0,0,0,0,0,0,0,0,255,0,0,255,0,255,0,0,255,0,0,0,0,0,0,0,0,255,0,0,0,0,0,255,0,0,0,0,255,0,255,255,0,0,255,0,255,0,0,0,255,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,255,0,255,0,255,0,0,255,255,0,0,0,255,0,0,255,0,0,0,0,0,0,0,0,0,0,255,0,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,255,0,0,255,0,0,0,255,255,255,255,0,255,0,255,0,255,0,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,0,0,0,255,0,255,0,0,0,0,0,0,0,255,0,0,0,0,255,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,255,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,255,0,0,0,255,0,0,255,0,0,0,0,255,0,0,0,255,0,0,255,255,255,0,0,0,255,0,0,0,0,255,0,255,0,0,0,0,0,255,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,255,0,0,255,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,255,0,255,0,0,0,0,0,0,0,255,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,255,0,255,255,0,255,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,255,255,255,0,0,255,0,0,0,0,0,0,255,0,255,0,0,255,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0,0,0,0,255,0,0,0,0,0,0,255,255,0,0,0,255,255,0,255,0,255,0,255,0,0,0,0,255,0,0,0,255,0,0,0,0,0,0,0,255,0,0,255,0,0,255,0,255,255,255,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,255,255,255,0,0,255,0,0,0,255,0,255,0,0,255,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,255,0,0,0,255,0,255,255,0,255,0,255,0,0,255,0,0,0,0,0,255,255,255,0,0,0,255,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,255,0,0,0,255,0,255,0,255,0,255,0,0,0,255,0,0,0,0,255,0,0,0,0,0,0,255,0,255,0,0,0,0,0,255,255,0,0,255,0,255,255,0,0,0,0,0,255,255,0,0,255,255,0,0,0,0,255,255,0,0,255,0,0,0,255,0,0,0,255,0,0,0,0,0,255,255,0,0,0,255,0,0,255,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,255,0,255,0,0,0,0,0,255,0,255,0,0,255,0,255,0,0,0,0,0,255,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,0,0,0,0,0,0,255,0,0,0,0,255,0,255,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,255,255,0,0,255,255,0,0,0,0,255,0,0,255,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,255,255,0,0,255,0,255,0,0,255,255,0,0,0,0,255,255,0,0,255,0,0,0,255,0,0,0,0,255,0,0,255,0,255,255,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,255,255,0,255,0,0,0,255,0,255,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,255,0,0,255,0,255,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,255,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0,255,0,0,0,0,255,0,0,255,0,0,0,255,255,0,0,255,0,0,255,0,0,0,0,255,0,0,0,0,255,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,255,0,255,0,0,0,0,0,0,0,0,255,0,0,0,255,0,0,255,0,255,0,0,0,0,0,255,255,0,0,0,0,0,255,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,255,255,0,0,0,0,0,0,0,255,0,255,0,0,0,0,0,0,0,0,0,255,255,255,0,255,255,0,0,255,0,0,255,0,0,0,255,0,0,0,0,255,0,0,0,0,255,0,255,0,0,0,0,0,255,255,0,0,0,0,0,255,0,0,0,255,255,0,255,0,0,0,255,0,255,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,255,255,0,0,0,0,0,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,255,0,0,0,255,0,255,0,0,0,0,0,255,0,0,0,0,0,0,0,0,255,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,0,0,0,255,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,255,255,0,0,255,0,0,0,255,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,255,0,0,0,0,0,0,0,0,255,0,0,255,0,0,255,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,255,0,255,0,0,0,0,0,0,255,0,0,0,0,255,0,0,0,0,255,0,0,0,0,255,255,255,0,255,0,0,0,255,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,0,0,255,0,0,0,0,0,255,0,255,0,255,0,255,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,255,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,255,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,255,0,255,0,0,0,0,0,0,0,0,0,0,0,255,0,255,0,0,255,0,0,0,0,0,255,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,255,0,0,255,255,0,0,0,255,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,255,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,255,0,255,0,0,0,0,0,255,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,255,0,0,0,255,0,0,0,0,0,0,0,0,0,255,255,0,255,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,255,0,255,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,255,255,255,0,0,0,255,0,0,255,0,255,0,0,0,0,0,255,0,0,0,0,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,255,0,255,0,0,0,255,0,0,255,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,255,255,0,0,0,255,0,0,0,0,0,0,0,255,0,0,0,0,255,0,0,0,0,0,255,0,0,0,0,0,0,255,0,0,0,0,255,0,0,0,255,0,0,255,0,0,0,0,0,255,0,0,0,0,255,0,0,0,255,0,0,255,255,255,0,0,0,0,0,0,0,0,0,0,255,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,255,255,0,0,255,0,0,0,255,0,0,255,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0,0,0,0,0,255,0,0,255,0,255,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,255,0,255,0,0,0,255,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,255,0,0,0,0,255,0,0,255,0,0,0,255,0,255,0,0,255,0,0,0,0,0,255,0,0,0,0,0,255,255,0,0,0,255,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,255,0,0,255,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,255,0,255,255,0,0,0,0,255,0,0,0,255,0,255,0,0,0,255,0,255,0,255,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,255,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,255,255,0,255,0,0,0,0,255,0,0,255,0,0,255,255,255,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,255,255,0,0,0,0,255,255,0,0,0,0,0,255,0,255,0,0,0,0,0,255,0,255,0,0,0,255,255,0,0,0,0,0,255,0,0,0,255,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,0,0,255,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0,0,0,0,0,255,0,0,255,0,255,0,0,0,255,255,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,255,0,255,0,0,0,255,0,0,0,0,0,255,0,0,0,0,255,0,0,255,0,255,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,0,255,0,0,0,0,0,0,0,0,255,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,255,255,0,255,0,0,255,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,255,0,0,255,0,0,0,0,0,0,0,0,255,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0,255,0,0,0,0,0,0,0,255,0,0,0,255,255,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,255,255,0,0,255,0,0,0,0,255,255,0,0,0,0,0,0,0,0,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,255,255,0,0,0,0,0,0,0,255,0,255,0,0,0,255,0,0,0,0,255,0,0,255,0,0,0,0,0,255,0

times 368640-($-$$) db 0   ;fill up floppy

